<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
  crossorigin="anonymous"></script>

<script>
  // ALL-IN-ONE SOLUTION: KaTeX + Swup Integration

  // Configuration
  const KATEX_CONFIG = {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\[", right: "\\]", display: true},
      {left: "\\(", right: "\\)", display: false}
    ],
    ignoredTags: ["script", "noscript", "style", "textarea", "pre", "code"],
    throwOnError: false
  };

  // Main render function
  function renderKatex() {
    // Check if KaTeX is loaded
    if (typeof renderMathInElement !== "function") {
      console.log("â³ Waiting for KaTeX to load...");
      return;
    }

    // Get the content area
    const contentArea = document.getElementById('swup') || document.body;

    try {
      renderMathInElement(contentArea, KATEX_CONFIG);
      console.log("âœ… KaTeX rendered successfully");
    } catch (error) {
      console.error("âŒ KaTeX rendering error:", error);
    }
  }

  // Try to render, retry if KaTeX isn't loaded yet
  function renderKatexWithRetry(maxRetries = 10, delay = 100) {
    let attempts = 0;

    const attempt = () => {
      if (typeof renderMathInElement === "function") {
        renderKatex();
      } else if (attempts < maxRetries) {
        attempts++;
        setTimeout(attempt, delay);
      } else {
        console.warn("âš ï¸ KaTeX auto-render not available after", maxRetries, "attempts");
      }
    };

    attempt();
  }

  // Setup Swup integration
  function setupSwupIntegration() {
    // Check if Swup is available
    if (window.swup) {
      window.swup.hooks.on('page:view', () => {
        console.log("ðŸ”„ Swup transition complete, re-rendering KaTeX...");
        // Small delay to ensure DOM is fully updated
        setTimeout(() => renderKatexWithRetry(3, 50), 50);
      });
      console.log("âœ… KaTeX-Swup integration ready");
    } else {
      // Swup not ready yet, try again
      setTimeout(setupSwupIntegration, 100);
    }
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function () {
    console.log("ðŸš€ Initializing KaTeX...");

    // Initial render
    renderKatexWithRetry();

    // Setup Swup integration
    setupSwupIntegration();
  });

  // Also expose the render function globally for manual use
  window.renderKatex = renderKatex;
</script>
