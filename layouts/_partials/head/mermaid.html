<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  let initialized = false;

  function renderMermaid() {
    const contentArea = document.getElementById('swup') || document.body;
    const mermaidBlocks = contentArea.querySelectorAll('.language-mermaid, .mermaid');

    if (mermaidBlocks.length === 0) {
      console.log("â„¹ï¸ No mermaid blocks found on this page");
      return;
    }

    if (!initialized) {
      mermaid.initialize({startOnLoad: false, theme: 'dark'});
      initialized = true;
    }

    mermaidBlocks.forEach(el => {
      if (el.dataset.processed === 'true') {
        const source = el.dataset.mermaidSource;
        if (source) {
          el.innerHTML = source;
          el.removeAttribute('data-processed');
        }
      } else {
        el.dataset.mermaidSource = el.textContent;
      }
    });

    mermaid.run({nodes: mermaidBlocks})
      .then(() => console.log("âœ… Mermaid rendered successfully"))
      .catch(err => console.error("âŒ Mermaid rendering error:", err));
  }

  function renderMermaidWithRetry(maxRetries = 10, delay = 100) {
    let attempts = 0;

    const attempt = () => {
      if (typeof mermaid.initialize === "function") {
        renderMermaid();
      } else if (attempts < maxRetries) {
        attempts++;
        setTimeout(attempt, delay);
      } else {
        console.warn("âš ï¸ Mermaid auto-render not available after", maxRetries, "attempts");
      }
    };

    attempt();
  }

  // Setup Swup integration
  function setupSwupIntegration() {
    // Check if Swup is available
    if (window.swup) {
      window.swup.hooks.on('page:view', () => {
        console.log("ðŸ”„ Swup transition complete, re-rendering mermaid...");
        // Small delay to ensure DOM is fully updated
        setTimeout(() => renderMermaidWithRetry(3, 50), 50);
      });
      console.log("âœ… Mermaid-Swup integration ready");
    } else {
      // Swup not ready yet, try again
      setTimeout(setupSwupIntegration, 100);
    }
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function () {
    console.log("ðŸš€ Initializing KaTeX...");

    // Initial render
    renderMermaidWithRetry();

    // Setup Swup integration
    setupSwupIntegration();
  });



</script>
